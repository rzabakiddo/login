<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login</title>
    <link rel="stylesheet" href="style.css">
    <script type="text/javascript">
        function error(title,content) {
            let error = document.getElementById('error');
            document.getElementById('erT').innerText=title
            document.getElementById('erC').innerText=content
            error.classList.remove('show');
            void error.offsetWidth;
            error.classList.add('show');
        }
        let wserv = new WebSocket('ws://dv8.synology.me:12341')
        let connected = false;
        let STATE = -1;
        let yourName = "";
        wserv.onopen = function () {
            connected = true;
        }
        wserv.onmessage = function (data) {
            if (data == null) return;
            if (data.data.startsWith("redir")) {
                if (data.data.endsWith("exist")) {
                    document.getElementById('status').innerText = "Please enter password";
                    document.getElementById('status').style.display = '';
                    document.getElementById('ename').type = 'password';
                    yourName=document.getElementById('ename').value
                    document.getElementById('ename').value = '';
                    document.getElementById('ename').placeholder = 'Enter password';
                    STATE = 0;
                } else {
                    document.getElementById('status').innerText = "Please create password";
                    document.getElementById('status').style.display = '';
                    document.getElementById('ename').type = 'password';
                    document.getElementById('panel').style.height='20vh';
                    yourName=document.getElementById('ename').value
                    document.getElementById('ename').value = '';
                    document.getElementById('ename').placeholder = 'Enter password';
                    document.getElementById('repeat').style.display = '';
                    STATE = 1;
                }
            }else if(data.data.startsWith("success")) {
                if(data.data.indexOf("|")) {
                    let guwno = data.data.split("|");
                    localStorage.setItem("piwo_password",guwno[1]);
                    localStorage.setItem("piwo_username",yourName);
                    location.href="https://rzabakiddo.github.io/comunicator/?dataPush="+yourName+"|"+guwno[1];
                }
            }else {
                if(data.data.indexOf("|")) {
                    let guwno = data.data.split("|");
                    error("Error",guwno[1]);
                }
            }

        }
        wserv.onerror = function () {
            alert("An error occurred")
        }
        wserv.onclose = function () {
            wserv = new WebSocket('ws://dv8.synology.me:12341')
        }
        onkeydown = function (event) {
            if (document.getElementById('ename').value != "")
                if (event.code == "Enter")
                    if (connected) {
                        if (STATE == -1)
                            wserv.send("0" + document.getElementById('ename').value)
                        if (STATE == 0)
                            wserv.send("1" + yourName+"|"+document.getElementById('ename').value)
                        if (STATE == 1)
                            if (document.getElementById('ename').value == document.getElementById('repeat').value)
                                wserv.send("1" + yourName+"|"+document.getElementById('ename').value)
                            else
                                alert("Passwords must match each other")
                    }
        }
    </script>
</head>
<body>
<img src="wyczesane_tlo.png" id="test">
<div id="bg">
<img src="piwo.gif" id="te">
<h4 id="opis">Picie piwa end-to-end</h4>
<h2 id="status" style="text-align: center; text-shadow: 0 0 5px white, 0 0 2px white; font-family: Arial; font-weight: lighter; color: #333; display: none;"></h2>
<div id="panel">
    <input id="ename" type="text" placeholder="Enter your name">
    <input id="repeat" type="password" style="display: none" placeholder="Repeat password">
</div>
<div id="error">
    <h2 id="erT">Title</h2>
    <a id="erC">Content</a>
</div>
</div>
</body>
</html>
